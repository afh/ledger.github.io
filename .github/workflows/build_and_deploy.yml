name: Build and Deploy static content to GitHub Pages

on:
  push:
    branches: master
  pull_request:
    branches: master

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
 build:
   environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

   runs-on: ubuntu-latest
   steps:
   - uses: cachix/install-nix-action@v20
     with:
       nix_path: nixpkgs=channel:nixos-unstable

   - uses: actions/checkout@v3
   - name: Build website
     run: |
      nix build .
      mkdir -p build
      cp -R result/* build

   - name: Build documentation
     env:
       OWNER: afh
       REPO: ledger
     run: |
      # TODO: change ledger to ${OWNER} prior to merging
      LATEST=$(curl -sqI -w '%{redirect_url}' -o /dev/null https://github.com/ledger/${REPO}/releases/latest | awk -F/ '{print $NF}')
      # TODO: remove this override prior to merging
      LATEST=web-docs
      nix build github:${OWNER}/${REPO}/${LATEST}#web-docs
      mkdir -p build/doc
      cp result/share/doc/ledger/ledger* build/doc

   - name: Setup Pages
     uses: actions/configure-pages@v3
   - name: Upload artifact
     uses: actions/upload-pages-artifact@v1
     with:
       path: 'build'
   - name: Deploy to GitHub Pages
     id: deployment
     uses: actions/deploy-pages@v1
